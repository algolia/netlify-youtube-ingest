<h1>Netlify function to index YouTube videos on Algolia</h1>
<p>This is a quick script to index (or just grab JSON) for youtube videos.</p>
<h2>Requirements</h2>
<ul>
<li><a href="https://algolia.com/signup?utm_source=social&amp;utm_medium=github&amp;utm_campaign=devrel_youtube&amp;utm_id=integrations">Algolia account</a> with an app ID</li>
<li><a href="https://developers.google.com/youtube/v3">YouTube Developers API Key</a></li>
</ul>
<h2>Quick Deploy</h2>
<p><a href="https://app.netlify.com/start/deploy?repository=https://github.com/brob/netlify-youtube-ingest"><img src="https://www.netlify.com/img/deploy/button.svg" alt="Deploy to Netlify"></a></p>
<p>Use the &quot;Deploy to Netlify&quot; Button above. It will ask you for some environment variables:</p>
<ul>
<li>YouTube API key</li>
<li>Algolia App ID</li>
<li>Algolia Search API key</li>
<li>Algolia Admin API key (for writing to the index)</li>
<li>Algolia Index name (if the index doesn't exist, the function will create it)</li>
</ul>
<p>After the first deploy, hit the <code>/.netlify/functions/getYoutubeJson</code> endpoint with a <code>channelId</code>, <code>maxResults</code>, and <code>index=true</code> query parameters (detailed below). This will index the most recent <code>n</code> videos for the channel provided (where <code>n</code> is the <code>maxResults</code> value).</p>
<p>Once indexed, the frontend for this microsite will work (or you can use the index elsewhere).</p>
<p>To keep the index fresh, you'll want to create a way to index new content. In <a href="https://ifttt.com">IFTTT</a>, you can set up a &quot;<a href="https://ifttt.com/youtube/triggers/new_video_by_channel">New YouTube video by channel</a>&quot; trigger that can fire a webhook action to the <code>/.netlify/functions/getYoutubeByUrl</code> function and provide the new video's URL as the <code>videoUrl</code> parameter with <code>index=true</code>. For every new video, your index will be updated.</p>
<p>By default, these functions will scrape the following details:</p>
<ul>
<li>Title</li>
<li>Description</li>
<li>Tags</li>
<li>Video Id (as objectID)</li>
<li>Comment Count</li>
<li>Likes</li>
<li>Favorites</li>
<li>Views</li>
</ul>
<p>You can use all of this information as ranking and sorting inside your <a href="https://www.algolia.com/dashboard">Algolia dashboard</a> and customize the search results.</p>
<h2>Installation</h2>
<p>In your Netlify project, create (or use) your Netlify functions directory. If you don't have one, create a new directory:</p>
<pre><code class="language-sh">mkdir /netlify/functions
</code></pre>
<p>Put the contents of <code>netlify/functions/getYoutube.js</code> into this directory.</p>
<p>Install the dependencies:</p>
<pre><code class="language-sh">npm install algoliasearch axios dotenv
</code></pre>
<p>To run locally, use <a href="https://www.netlify.com/products/dev/">the Netlify Dev CLI</a>.</p>
<pre><code class="language-sh">netlify dev
</code></pre>
<h3>Environment variables</h3>
<p>The function requires environment variables to connect to the YouTube API and an Algolia index.</p>
<table>
<thead>
<tr>
<th>variable</th>
<th>use</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>YOUTUBE_KEY</code></td>
<td>Your API Key for <a href="https://developers.google.com/youtube/v3">the YouTube API</a></td>
</tr>
<tr>
<td><code>ALGOLIA_APP_ID</code></td>
<td>The Algolia app ID</td>
</tr>
<tr>
<td><code>ALGOLIA_API_KEY</code></td>
<td>Your Algolia API key. This needs write permissions to write to the index</td>
</tr>
<tr>
<td><code>ALGOLIA_SEARCH_KEY</code></td>
<td>Your Algolia search-only key to power the frontend</td>
</tr>
<tr>
<td><code>VIDEO_INDEX</code></td>
<td>The Index name where your search index will be stored in Algolia</td>
</tr>
</tbody>
</table>
<h2>Usage</h2>
<p>After installation, you'll have access to the following endpoints on your Netlify site:</p>
<p><code>/.netlify/functions/getYoutubeJson</code>
<code>/.netlify/functions/getYoutubeByUrl</code></p>
<h2>Parameters</h2>
<h3>`getYoutubeJson</h3>
<pre><code class="language-sh">/.netlify/functions/getYoutubeJson
        ?channelID=&lt;your channel id&gt;
        
        &amp;maxResults=&lt;number of results&gt;
        
        &amp;index=&lt;true/false to index&gt;
</code></pre>
<table>
<thead>
<tr>
<th>parameter</th>
<th>type</th>
<th>what it does</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>channelId</code></td>
<td><code>string</code></td>
<td>The ID of the YouTube channel to scrape</td>
</tr>
<tr>
<td><code>maxResults</code></td>
<td><code>string</code></td>
<td>How many results to return (this is ordered by date, so it will get &quot;latest&quot; <code>n</code> videos)</td>
</tr>
<tr>
<td><code>index</code></td>
<td><code>boolean</code></td>
<td>if <code>true</code> will submit the videos in the list to Algolia (using env variables) if <code>false</code> will just display JSON in the body of the response</td>
</tr>
</tbody>
</table>
<h3><code>getYoutubeByUrl</code></h3>
<p>This endpoint is mostly intended to be used with an IFTTT Applet. IFTTT has a Trigger action that is for new YouTube video on a channel. When there's a new video, it can then fire a webhook to this endpoint and provide the URL for the video. The endpoint then gets the video ID from the video and indexes the video content and id.</p>
<table>
<thead>
<tr>
<th>parameter</th>
<th>type</th>
<th>what it does</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>videoUrl</code></td>
<td><code>string</code></td>
<td>The URL to the youtube video (this is the way to get it in IFTTT). This will be used to get the ID of the video</td>
</tr>
<tr>
<td><code>index</code></td>
<td><code>boolean</code></td>
<td>if <code>true</code> will submit the videos in the list to Algolia (using env variables) if <code>false</code> will just display JSON in the body of the response</td>
</tr>
</tbody>
</table>
